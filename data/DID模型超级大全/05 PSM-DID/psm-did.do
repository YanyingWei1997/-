*==============================================================================*
*                         双重差分法(DID) | PSM - DID                          *
*==============================================================================*

*-【说明】

更多资料，请关注微信公众号【草莓科研服务网】

********************************************************************************

*-【数据来源】

*- 李青原和章尹赛楠（2021），参见在《中国工业经济》网站（http://ciejournal.ajcass.org/Magazine/show/?id=77331）

*-【参考文献】

*- 李青原, 章尹赛楠. 金融开放与资源配置效率——来自外资银行进入中国的证据[J]. 中国工业经济, 2021(05): 95-113.

********************************************************************************

*- Stata Version: 16 | 17

*- 定义路径

cd "C:\Users\KEMOSABE\Desktop\exp"

*- 设置图片输出样式

graph set window fontface     "Times New Roman"
graph set window fontfacesans "宋体"
set scheme s1color  

use 行业数据.dta, clear

*- 定义全局暂元

global xlist  "ADM PPE ADV RD HHI INDSIZE NFIRMS FCFIRM MARGIN LEVDISP SIZEDISP ENTRYR EXITR"
global regopt "absorb(city ind3) cluster(city#ind3 city#year) keepsing"

*- 生成处理组虚拟变量

gen treated = ( city == 5101 | city == 5000 | city == 2102 | city == 3501    ///
              | city == 4401 | city == 3701 | city == 3201 | city == 3702    ///
              | city == 3101 | city == 4403 | city == 1200 | city == 4201    ///
              | city == 4404 | prov ==   44 | prov ==   45 | prov ==   43    ///
              | prov ==   32 | prov ==   33 | city == 1100 | city == 5301    ///
              | city == 2101 | city == 3502 | city == 6101 | city == 2201    ///
              | city == 2301 | city == 6201 | city == 6401 )

save psmdata.dta, replace

**# 一、截面匹配

use psmdata.dta, clear

**# 1.1 卡尺最近邻匹配（1:2）

set  seed 0000
gen  norvar_1 = rnormal()
sort norvar_1

psmatch2 treated $xlist , outcome(TFPQD_OP) logit neighbor(2) ties common    ///
                          ate caliper(0.05)

save csdata.dta, replace

/*
Logistic regression                             Number of obs     =     81,567
                                                LR chi2(13)       =    5973.89
                                                Prob > chi2       =     0.0000
Log likelihood = -53407.844                     Pseudo R2         =     0.0530

------------------------------------------------------------------------------
     treated |      Coef.   Std. Err.      z    P>|z|     [95% Conf. Interval]
-------------+----------------------------------------------------------------
         ADM |   2.303432   .1007328    22.87   0.000     2.105999    2.500865
         PPE |  -1.222116   .0342674   -35.66   0.000    -1.289279   -1.154953
         ADV |   21.56327   3.731756     5.78   0.000     14.24917    28.87738
          RD |   18.12885   3.306851     5.48   0.000     11.64754    24.61016
         HHI |  -.4729895    .065837    -7.18   0.000    -.6020276   -.3439513
     INDSIZE |   .0015667   .0103893     0.15   0.880     -.018796    .0219294
      NFIRMS |   .4045981   .0190289    21.26   0.000     .3673021     .441894
      FCFIRM |   2.685802   .1414342    18.99   0.000     2.408596    2.963008
      MARGIN |   .8316006   .0620282    13.41   0.000     .7100276    .9531736
     LEVDISP |  -2.178396   .0987579   -22.06   0.000    -2.371958   -1.984835
    SIZEDISP |   .2341893   .0247433     9.46   0.000     .1856934    .2826852
      ENTRYR |  -.0103419   .0385426    -0.27   0.788    -.0858841    .0652002
       EXITR |  -.1123095   .0605613    -1.85   0.064    -.2310075    .0063884
       _cons |  -.9478736   .1123736    -8.44   0.000    -1.168122   -.7276253
------------------------------------------------------------------------------
----------------------------------------------------------------------------------------
        Variable     Sample |    Treated     Controls   Difference         S.E.   T-stat
----------------------------+-----------------------------------------------------------
        TFPQD_OP  Unmatched | 2.24921913   2.35179198  -.102572852   .006214925   -16.50
                        ATT | 2.24921615   2.35605481  -.106838668   .008017304   -13.33
                        ATU | 2.35179488   2.28215595  -.069638929            .        .
                        ATE |                          -.089340447            .        .
----------------------------+-----------------------------------------------------------
Note: S.E. does not take into account that the propensity score is estimated.

 psmatch2: |   psmatch2: Common
 Treatment |        support
assignment | Off suppo  On suppor |     Total
-----------+----------------------+----------
 Untreated |         1     38,367 |    38,368 
   Treated |         1     43,198 |    43,199 
-----------+----------------------+----------
     Total |         2     81,565 |    81,567 
*/

**# 1.2 平衡性检验

pstest, both graph saving(balancing_assumption, replace)
graph export "balancing_assumption.emf", replace

/*
----------------------------------------------------------------------------------------
                Unmatched |       Mean               %reduct |     t-test    |  V(T)/
Variable          Matched | Treated Control    %bias  |bias| |    t    p>|t| |  V(C)
--------------------------+----------------------------------+---------------+----------
ADM                    U  | .07524   .06583     11.5         |  16.40  0.000 |  1.07*
                       M  | .07524   .07762     -2.9    74.7 |  -3.92  0.000 |  0.77*
                          |                                  |               |
PPE                    U  | .34533   .40875    -29.7         | -42.32  0.000 |  0.93*
                       M  | .34532   .34725     -0.9    96.9 |  -1.36  0.173 |  1.02*
                          |                                  |               |
ADV                    U  | .00044   .00036      4.4         |   6.22  0.000 |  1.26*
                       M  | .00044   .00042      1.1    75.5 |   1.50  0.133 |  1.03*
                          |                                  |               |
RD                     U  | .00047    .0003      6.9         |   9.77  0.000 |  1.63*
                       M  | .00047   .00045      0.5    92.1 |   0.72  0.470 |  1.03*
                          |                                  |               |
HHI                    U  |  .2341   .26739    -19.8         | -28.19  0.000 |  0.95*
                       M  | .23409   .23365      0.3    98.7 |   0.38  0.703 |  0.97*
                          |                                  |               |
INDSIZE                U  | 13.279   12.873     29.9         |  42.60  0.000 |  1.01
                       M  | 13.279   13.291     -0.9    96.9 |  -1.31  0.189 |  0.85*
                          |                                  |               |
NFIRMS                 U  | 2.6806   2.3742     37.9         |  53.74  0.000 |  1.35*
                       M  | 2.6807   2.6892     -1.1    97.2 |  -1.41  0.159 |  0.89*
                          |                                  |               |
FCFIRM                 U  | .01606   .00744     15.2         |  21.47  0.000 |  2.16*
                       M  | .01606   .01534      1.3    91.7 |   1.60  0.109 |  1.01
                          |                                  |               |
MARGIN                 U  |  .8387   .83491      2.9         |   4.17  0.000 |  1.01
                       M  |  .8387   .83786      0.6    77.9 |   0.95  0.343 |  0.99
                          |                                  |               |
LEVDISP                U  | .25657   .26916    -16.9         | -24.11  0.000 |  0.81*
                       M  | .25656   .25834     -2.4    85.9 |  -3.69  0.000 |  0.99
                          |                                  |               |
SIZEDISP               U  |  1.211   1.1797      8.3         |  11.88  0.000 |  0.85*
                       M  |  1.211   1.2131     -0.5    93.4 |  -0.83  0.405 |  0.97*
                          |                                  |               |
ENTRYR                 U  |   .081   .08743     -3.4         |  -4.82  0.000 |  0.92*
                       M  |   .081   .07818      1.5    56.1 |   2.25  0.024 |  1.05*
                          |                                  |               |
EXITR                  U  | .03935    .0459     -5.4         |  -7.74  0.000 |  0.81*
                       M  | .03935   .04031     -0.8    85.4 |  -1.21  0.225 |  0.96*
                          |                                  |               |
----------------------------------------------------------------------------------------
* if variance ratio outside [0.98; 1.02] for U and [0.98; 1.02] for M

-----------------------------------------------------------------------------------
 Sample    | Ps R2   LR chi2   p>chi2   MeanBias   MedBias      B      R     %Var
-----------+-----------------------------------------------------------------------
 Unmatched | 0.053   5936.79    0.000     14.8      11.5      55.2*   1.17     85
 Matched   | 0.000     45.01    0.000      1.1       0.9       4.6    0.91     77
-----------------------------------------------------------------------------------
* if B>25%, R outside [0.5; 2]
(file balancing_assumption.gph saved)
*/

psgraph, saving(common_support, replace)
graph export "common_support.emf", replace

**# 1.3 倾向得分值的核密度图

sum _pscore if treated == 1, detail  // 处理组的倾向得分均值为0.5632

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .2719525       .1282481
 5%     .3455629       .1516158
10%     .3902731       .1594052       Obs              43,199
25%     .4707828       .1628684       Sum of Wgt.      43,199

50%     .5622991                      Mean           .5631773
                        Largest       Std. Dev.      .1314877
75%     .6572162       .9296594
90%     .7389691       .9328122       Variance        .017289
95%     .7820771       .9363678       Skewness      -.0266156
99%     .8417256       .9415182       Kurtosis        2.55112
*/

*- 匹配前

sum _pscore if treated == 0, detail

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%        .2394       .1338618
 5%     .3003465       .1443443
10%     .3367647       .1474181       Obs              38,368
25%     .4048551       .1475328       Sum of Wgt.      38,368

50%     .4858004                      Mean           .4918241
                        Largest       Std. Dev.      .1233355
75%      .570338       .9288358
90%     .6543014       .9348959       Variance       .0152117
95%     .7081627       .9357671       Skewness       .3317101
99%     .8129114       .9444853       Kurtosis       3.020912
*/

twoway(kdensity _pscore if treated == 1, lpattern(solid)                     ///
              lcolor(black)                                                  ///
              lwidth(thin)                                                   ///
              scheme(qleanmono)                                              ///
              ytitle("{stSans:核}""{stSans:密}""{stSans:度}",                ///
                     size(medlarge) orientation(h))                          ///
              xtitle("{stSans:匹配前的倾向得分值}",                          ///
                     size(medlarge))                                         ///
              xline(0.5632   , lpattern(solid) lcolor(black))                ///
              xline(`r(mean)', lpattern(dash)  lcolor(black))                ///
              saving(kensity_cs_before, replace))                            ///
      (kdensity _pscore if treated == 0, lpattern(dash)),                    ///
      xlabel(     , labsize(medlarge) format(%02.1f))                        ///
      ylabel(0(1)4, labsize(medlarge))                                       ///
      legend(label(1 "{stSans:处理组}")                                      ///
             label(2 "{stSans:控制组}")                                      ///
             size(medlarge) position(1) symxsize(10))

graph export "kensity_cs_before.emf", replace

discard

*- 匹配后

sum _pscore if treated == 0 & _weight != ., detail

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .2477856       .1523638
 5%     .3147208       .1524279
10%     .3546398       .1580033       Obs              29,592
25%     .4246349       .1610702       Sum of Wgt.      29,592

50%     .5064606                      Mean           .5109521
                        Largest       Std. Dev.       .123688
75%     .5901474       .9267854
90%     .6746295       .9288358       Variance       .0152987
95%     .7248855       .9348959       Skewness       .2440785
99%     .8243294       .9357671       Kurtosis        2.95412
*/

twoway(kdensity _pscore if treated == 1, lpattern(solid)                     ///
              lcolor(black)                                                  ///
              lwidth(thin)                                                   ///
              scheme(qleanmono)                                              ///
              ytitle("{stSans:核}""{stSans:密}""{stSans:度}",                ///
                     size(medlarge) orientation(h))                          ///
              xtitle("{stSans:匹配后的倾向得分值}",                          ///
                     size(medlarge))                                         ///
              xline(0.5632   , lpattern(solid) lcolor(black))                ///
              xline(`r(mean)', lpattern(dash)  lcolor(black))                ///
              saving(kensity_cs_after, replace))                             ///
      (kdensity _pscore if treated == 0 & _weight != ., lpattern(dash)),     ///
      xlabel(     , labsize(medlarge) format(%02.1f))                        ///
      ylabel(0(1)4, labsize(medlarge))                                       ///
      legend(label(1 "{stSans:处理组}")                                      ///
             label(2 "{stSans:控制组}")                                      ///
             size(medlarge) position(1) symxsize(10))

graph export "kensity_cs_after.emf", replace

discard

**# 1.4 回归结果对比

use csdata.dta, clear

*- 基准回归1（混合OLS）

qui: reg TFPQD_OP FB $xlist , cluster(city)
est store m1

*- 基准回归2（固定效应模型）

qui: reghdfe TFPQD_OP FB $xlist , $regopt
est store m2

*- PSM-DID1（使用权重不为空的样本）

qui: reghdfe TFPQD_OP FB $xlist if _weight != ., $regopt
est store m3

*- PSM-DID2（使用满足共同支撑假设的样本）

qui: reghdfe TFPQD_OP FB $xlist if _support == 1, $regopt
est store m4

*- PSM-DID3（使用频数加权回归）

gen     weight = _weight * 2
replace weight = 1 if treated == 1 & _weight != .
qui: reghdfe TFPQD_OP FB $xlist [fweight = weight], $regopt
est store m5

** 或者

/*
gen     weight  = _weight * 2
replace weight  = 1 if treated == 1 & _weight != .
keep if weight != .
expand  weight
reghdfe TFPQD_OP FB $xlist , $regopt
est store m5
*/

*- 回归结果输出

local mlist_1 "m1 m2 m3 m4 m5"
reg2docx `mlist_1' using 截面匹配回归结果对比.docx, b(%6.4f) t(%6.4f)        ///
         scalars(N r2_a(%6.4f)) noconstant  replace                          ///
         mtitles("OLS" "FE" "Weight!=." "On_Support" "Weight_Reg")           ///
         title("基准回归及截面PSM-DID结果")

/*
local mlist_1 "m1 m2 m3 m4 m5"
esttab `mlist_1', mtitle("OLS" "FE" "Weight!=." "On_Support" "Weight_Reg")   ///
       b(%6.4f) t(%6.4f) s(N r2_a) nogap noconstant                          ///
       star(* 0.1 ** 0.05 *** 0.01)

--------------------------------------------------------------------------------------------
                      (1)             (2)             (3)             (4)             (5)   
                      OLS              FE       Weight!=.      On_Support      Weight_Reg   
--------------------------------------------------------------------------------------------
FB                -0.1243***      -0.0496***      -0.0545***      -0.0497***      -0.0422***
                (-5.2480)       (-3.6531)       (-3.9823)       (-3.6550)       (-2.9228)   
ADM                1.0682***       0.8719***       0.9287***       0.8719***       0.9839***
                (17.6388)       (18.0260)       (16.1842)       (18.0262)       (12.0535)   
PPE               -0.1183***      -0.0845***      -0.0784***      -0.0845***      -0.0813***
                (-4.3488)       (-5.4869)       (-4.3384)       (-5.4864)       (-3.6168)   
ADV                3.4239*         0.4029          1.6045          0.3975          2.3618   
                 (1.9284)        (0.2547)        (0.8734)        (0.2513)        (0.9525)   
RD                -1.1993         -3.5116***      -3.4516**       -3.4852***      -4.2360*  
                (-0.8120)       (-2.6572)       (-2.1919)       (-2.6371)       (-1.8977)   
HHI               -0.0284          0.1391***       0.1347***       0.1393***       0.0702   
                (-0.5123)        (3.7371)        (3.2368)        (3.7409)        (1.3515)   
INDSIZE            0.1061***       0.0398***       0.0425***       0.0398***       0.0541***
                 (6.4798)        (5.1231)        (5.1566)        (5.1227)        (5.1725)   
NFIRMS            -0.2011***      -0.1012***      -0.1048***      -0.1012***      -0.1324***
                (-7.0272)       (-8.2637)       (-7.9029)       (-8.2608)       (-7.5215)   
FCFIRM             0.2561**       -0.0343          0.0229         -0.0335          0.0774   
                 (2.5595)       (-0.5604)        (0.2952)       (-0.5472)        (0.6958)   
MARGIN             0.2333***       0.2377***       0.2472***       0.2377***       0.2808***
                 (6.6555)        (8.2641)        (7.5753)        (8.2641)        (6.3765)   
LEVDISP            1.8228***       1.1270***       1.1118***       1.1271***       1.0811***
                (15.3788)       (20.1912)       (17.9101)       (20.1920)       (13.5927)   
SIZEDISP           0.1373***       0.0678***       0.0667***       0.0678***       0.0785***
                 (5.2810)        (4.5861)        (4.0912)        (4.5819)        (3.8797)   
ENTRYR             0.0735***       0.0732***       0.0573**        0.0732***       0.0684***
                 (2.9277)        (3.2806)        (2.4976)        (3.2805)        (2.6353)   
EXITR              0.0560*         0.0491*         0.0420          0.0492*        -0.0326   
                 (1.7687)        (1.7444)        (1.3206)        (1.7474)       (-0.8330)   
--------------------------------------------------------------------------------------------
N                   81567           81567           60078           81565          116882    // esttab命令中N默认为科学计数法，这里根据实际样本数进行调整，下同
r2_a               0.0646          0.1613          0.1548          0.1613          0.1592   
--------------------------------------------------------------------------------------------
t statistics in parentheses
* p<0.1, ** p<0.05, *** p<0.01
*/

**# 二、逐年匹配

use psmdata.dta, clear

**# 2.1 卡尺最近邻匹配（1:2）

forvalue i = 1998/2007{
      preserve
          capture {
              keep if year == `i'
              set seed 0000
              gen  norvar_2 = rnormal()
              sort norvar_2

              psmatch2 treated $xlist , outcome(TFPQD_OP) logit neighbor(2)  ///
                                        ties common ate caliper(0.05)

              save `i'.dta, replace
              }
      restore
      }

clear all

use 1998.dta, clear

forvalue k =1999/2007 {
      capture {
          append using `k'.dta
          }
      }

save ybydata.dta, replace

**# 2.2 倾向得分值的核密度图

sum _pscore if treated == 1, detail  // 处理组的倾向得分均值为0.5698

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%     .2462649       .0970248
 5%     .3280515       .1070863
10%     .3792415       .1209767       Obs              43,199
25%     .4720953       .1223726       Sum of Wgt.      43,199

50%     .5749079                      Mean            .569827
                        Largest       Std. Dev.      .1409699
75%     .6723992       .9418448
90%     .7531485       .9431685       Variance       .0198725
95%     .7943281       .9442054       Skewness      -.1636505
99%     .8578832       .9488408       Kurtosis       2.565248
*/

*- 匹配前

sum _pscore if treated == 0, detail

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%      .202491       .0956568
 5%     .2692991       .0965333
10%     .3099461       .1020349       Obs              38,368
25%     .3875343       .1085678       Sum of Wgt.      38,368

50%     .4792712                      Mean           .4843371
                        Largest       Std. Dev.      .1361458
75%     .5741765       .9391565
90%     .6637404       .9421781       Variance       .0185357
95%     .7196828       .9497313       Skewness       .2292698
99%     .8224753       .9510892       Kurtosis       2.825848
*/

twoway(kdensity _pscore if treated == 1, lpattern(solid)                     ///
              lcolor(black)                                                  ///
              lwidth(thin)                                                   ///
              scheme(qleanmono)                                              ///
              ytitle("{stSans:核}""{stSans:密}""{stSans:度}",                ///
                     size(medlarge) orientation(h))                          ///
              xtitle("{stSans:匹配前的倾向得分值}",                          ///
                     size(medlarge))                                         ///
              xline(0.5698   , lpattern(solid) lcolor(black))                ///
              xline(`r(mean)', lpattern(dash)  lcolor(black))                ///
              saving(kensity_yby_before, replace))                           ///
      (kdensity _pscore if treated == 0, lpattern(dash)),                    ///
      xlabel(     , labsize(medlarge) format(%02.1f))                        ///
      ylabel(0(1)3, labsize(medlarge))                                       ///
      legend(label(1 "{stSans:处理组}")                                      ///
             label(2 "{stSans:控制组}")                                      ///
             size(medlarge) position(1) symxsize(10))

graph export "kensity_yby_before.emf", replace

discard

*- 匹配后

sum _pscore if treated == 0 & _weight != ., detail

/*
                 psmatch2: Propensity Score
-------------------------------------------------------------
      Percentiles      Smallest
 1%      .218586       .1087206
 5%     .2908361        .116991
10%     .3341125       .1171478       Obs              29,017
25%     .4137743       .1252564       Sum of Wgt.      29,017

50%     .5051881                      Mean           .5081499
                        Largest       Std. Dev.      .1347087
75%     .5981689       .9180007
90%      .684632       .9205208       Variance       .0181464
95%     .7385517       .9307409       Skewness       .1364443
99%     .8327231       .9319533       Kurtosis       2.767411
*/

twoway(kdensity _pscore if treated == 1, lpattern(solid)                     ///
              lcolor(black)                                                  ///
              lwidth(thin)                                                   ///
              scheme(qleanmono)                                              ///
              ytitle("{stSans:核}""{stSans:密}""{stSans:度}",                ///
                     size(medlarge) orientation(h))                          ///
              xtitle("{stSans:匹配后的倾向得分值}",                          ///
                     size(medlarge))                                         ///
              xline(0.5698   , lpattern(solid) lcolor(black))                ///
              xline(`r(mean)', lpattern(dash)  lcolor(black))                ///
              saving(kensity_yby_after, replace))                            ///
      (kdensity _pscore if treated == 0 & _weight != ., lpattern(dash)),     ///
      xlabel(     , labsize(medlarge) format(%02.1f))                        ///
      ylabel(0(1)3, labsize(medlarge))                                       ///
      legend(label(1 "{stSans:处理组}")                                      ///
             label(2 "{stSans:控制组}")                                      ///
             size(medlarge) position(1) symxsize(10))

graph export "kensity_yby_after.emf", replace

discard

**# 2.3 逐年平衡性检验

*- 匹配前

forvalue i = 1998/2007 {
          capture {
              qui: logit treated $xlist i.ind3 if year == `i', vce(cluster prov)
              est store ybyb`i'
              estadd local Industry "Yes"
              }
          }

local ybyblist ybyb1998 ybyb1999 ybyb2000 ybyb2001 ybyb2002                  ///
               ybyb2003 ybyb2004 ybyb2005 ybyb2006 ybyb2007

reg2docx `ybyblist' using 逐年平衡性检验结果_匹配前.docx, b(%6.4f) t(%6.4f)  ///
         scalars(N r2_p(%6.4f)) noconstant replace                           ///
         indicate("Industry = *.ind3")                                       ///
         mtitles("1998b" "1999b" "2000b" "2001b" "2002b"                     ///
                 "2003b" "2004b" "2005b" "2006b" "2007b")                    ///
         title("逐年平衡性检验_匹配前")

/*
local ybyblist ybyb1998 ybyb1999 ybyb2000 ybyb2001 ybyb2002                  ///
               ybyb2003 ybyb2004 ybyb2005 ybyb2006 ybyb2007
esttab `ybyblist', mtitle("1998b" "1999b" "2000b" "2001b" "2002b"            ///
                          "2003b" "2004b" "2005b" "2006b" "2007b")           ///
       b(%6.4f) t(%6.4f) s(Industry N r2_p) nogap noconstant drop(*.ind3)    ///
       star(* 0.1 ** 0.05 *** 0.01)

*- 匹配前

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                      (1)             (2)             (3)             (4)             (5)             (6)             (7)             (8)             (9)            (10)   
                    1998b           1999b           2000b           2001b           2002b           2003b           2004b           2005b           2006b           2007b   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
treated                                                                                                                                                                     
ADM                2.2684***       2.3222***       2.0865***       1.9288**        1.4294*         2.0740**        2.0784*         1.5288          2.3137          2.7268** 
                 (2.7355)        (2.5959)        (2.8096)        (2.4781)        (1.9008)        (2.0923)        (1.9458)        (0.9822)        (1.3856)        (2.1562)   
PPE               -0.5244**       -0.3025         -0.7743***      -0.5716**       -0.7099***      -0.6272**       -1.0487***      -1.0451***      -0.8431*        -0.9608** 
                (-2.2990)       (-1.5852)       (-3.4052)       (-2.3569)       (-2.6279)       (-2.2244)       (-3.5397)       (-2.7774)       (-1.9164)       (-2.1682)   
ADV                0.0000          0.0000          0.0000         13.4355          0.0000          0.0000         26.4667**       34.6121**       31.8339**       16.2578   
                      (.)             (.)             (.)        (1.0514)             (.)             (.)        (2.4702)        (2.2337)        (2.2127)        (1.2177)   
RD                 0.0000          0.0000          0.0000         10.9171          0.0000          0.0000          0.0000         -1.3296         14.1701          8.3546   
                      (.)             (.)             (.)        (1.2536)             (.)             (.)             (.)       (-0.1238)        (1.5283)        (0.7065)   
HHI               -1.6439*        -1.6918**       -1.1028         -1.2699         -1.0869         -0.6338          0.0072          0.0714         -0.0496          0.0429   
                (-1.7219)       (-1.9652)       (-1.3282)       (-1.4922)       (-1.4629)       (-0.8633)        (0.0148)        (0.1513)       (-0.0896)        (0.0784)   
INDSIZE            0.5445*         0.4829*         0.3557          0.3033          0.2376          0.1528         -0.2555         -0.0907         -0.1805         -0.2358   
                 (1.7667)        (1.8760)        (1.4057)        (1.1672)        (0.9226)        (0.6146)       (-1.2398)       (-0.4178)       (-0.7170)       (-0.9694)   
NFIRMS            -0.3930         -0.2420          0.0200          0.1023          0.2644          0.3734          0.9632***       0.6899**        0.7769**        0.8697** 
                (-0.6612)       (-0.4746)        (0.0427)        (0.2083)        (0.5603)        (0.8035)        (2.7205)        (1.9736)        (2.0972)        (2.4071)   
FCFIRM             1.6635          0.7963          1.6429          1.1912          0.7410          0.6982          2.0390**        0.8335          1.1705          1.5674*  
                 (0.9054)        (0.4392)        (1.1530)        (0.6450)        (0.5633)        (0.6334)        (2.1761)        (0.6433)        (1.3389)        (1.6736)   
MARGIN             1.5995***       1.4034***       1.0741***       1.2462***       0.4034          0.8745**        1.2484**       -0.3829          0.7840          0.1712   
                 (3.5296)        (3.5031)        (2.8690)        (3.1566)        (0.8275)        (2.0900)        (2.3096)       (-0.3499)        (0.6127)        (0.1870)   
LEVDISP           -0.9378         -0.8800         -1.3296         -1.3270         -0.9001         -1.1339         -0.9631         -1.2057         -1.6036         -1.5013   
                (-0.4328)       (-0.5331)       (-0.7892)       (-0.7769)       (-0.5507)       (-0.6717)       (-0.5041)       (-0.6542)       (-0.9766)       (-0.9726)   
SIZEDISP          -0.0741          0.0517          0.0790          0.1699          0.1840          0.1689          0.5612***       0.3714          0.5487**        0.6102** 
                (-0.2874)        (0.2080)        (0.3297)        (0.7125)        (0.6938)        (0.7498)        (2.7553)        (1.4051)        (2.1442)        (2.1618)   
ENTRYR             0.0000         -0.0619          0.9535*         0.2964          0.0387          0.0183          0.0348         -0.6241         -0.6629**       -0.6837** 
                      (.)       (-0.1157)        (1.7572)        (0.5243)        (0.1305)        (0.0435)        (0.1230)       (-0.6853)       (-2.1473)       (-2.3081)   
EXITR             -0.9139          0.7341          0.0460         -0.5761         -0.3070          0.2523          0.8344**        0.0524         -0.5910         -0.5330   
                (-1.1158)        (1.1616)        (0.0659)       (-0.8138)       (-0.6607)        (0.4841)        (2.0014)        (0.1361)       (-0.9383)       (-0.7851)   
_cons             -8.6621***      -8.8834***      -7.3079***      -6.6187**       -5.6780**       -5.4720**       -2.9528         -2.3179         -2.4977         -1.5174   
                (-2.7961)       (-3.3483)       (-2.6862)       (-2.2210)       (-2.1561)       (-2.1240)       (-1.0200)       (-0.8532)       (-0.7556)       (-0.4968)   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Industry              Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes   
N                    6303            6600            6656            6845            7187            7601            9057            9428           10221           11207   
r2_p               0.1321          0.1301          0.1337          0.1368          0.1369          0.1351          0.1578          0.1351          0.1314          0.1368   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
t statistics in parentheses
* p<0.1, ** p<0.05, *** p<0.01
*/

*- 匹配后

forvalue i = 1998/2007 {
          capture {
              qui: logit treated $xlist i.ind3                               ///
                       if year == `i' & _weight != ., vce(cluster prov)
              est store ybya`i'
              estadd local Industry "Yes"
              }
          }

local ybyalist ybya1998 ybya1999 ybya2000 ybya2001 ybya2002                  ///
               ybya2003 ybya2004 ybya2005 ybya2006 ybya2007

reg2docx `ybyalist' using 逐年平衡性检验结果_匹配后.docx, b(%6.4f) t(%6.4f)  ///
         scalars(N r2_p(%6.4f)) noconstant replace                           ///
         indicate("Industry = *.ind3")                                       ///
         mtitles("1998a" "1999a" "2000a" "2001a" "2002a"                     ///
                 "2003a" "2004a" "2005a" "2006a" "2007a")                    ///
         title("逐年平衡性检验_匹配后")

/*
local ybyalist ybya1998 ybya1999 ybya2000 ybya2001 ybya2002                  ///
               ybya2003 ybya2004 ybya2005 ybya2006 ybya2007
esttab `ybyalist', mtitle("1998a" "1999a" "2000a" "2001a" "2002a"            ///
                          "2003a" "2004a" "2005a" "2006a" "2007a")           ///
       b(%6.4f) t(%6.4f) s(Industry N r2_p) nogap noconstant drop(*.ind3)    ///
       star(* 0.1 ** 0.05 *** 0.01)

*- 匹配后

----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
                      (1)             (2)             (3)             (4)             (5)             (6)             (7)             (8)             (9)            (10)   
                    1998a           1999a           2000a           2001a           2002a           2003a           2004a           2005a           2006a           2007a   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
treated                                                                                                                                                                     
ADM                0.8186          0.7099          1.0169          0.8462          0.1525          0.7434          0.0853          0.3600          0.8061          0.7568   
                 (1.0061)        (0.8124)        (1.3867)        (1.0619)        (0.2048)        (0.8235)        (0.0714)        (0.2385)        (0.4899)        (0.5814)   
PPE                0.2349          0.3703*         0.1335          0.1864          0.2028          0.0637         -0.0651         -0.1128         -0.0983         -0.1607   
                 (0.9089)        (1.9154)        (0.5660)        (0.7556)        (0.7784)        (0.2231)       (-0.2131)       (-0.2964)       (-0.2179)       (-0.3868)   
ADV                0.0000          0.0000          0.0000          6.5454          0.0000          0.0000         15.1587          4.7196         12.2655         -1.5428   
                      (.)             (.)             (.)        (0.6044)             (.)             (.)        (1.3536)        (0.2908)        (0.8152)       (-0.1188)   
RD                 0.0000          0.0000          0.0000         -8.3398          0.0000          0.0000          0.0000         -9.1278         -0.9288        -12.7757   
                      (.)             (.)             (.)       (-0.6978)             (.)             (.)             (.)       (-0.9596)       (-0.0959)       (-0.9324)   
HHI               -0.4786         -0.4828         -0.4323         -0.6529         -0.4950         -0.2469         -0.0630         -0.0505          0.2196          0.0863   
                (-0.5030)       (-0.5685)       (-0.5165)       (-0.7708)       (-0.6700)       (-0.3173)       (-0.1331)       (-0.1042)        (0.4048)        (0.1496)   
INDSIZE            0.2424          0.2039          0.0910          0.1361          0.1026          0.0569         -0.0786          0.0223         -0.0374         -0.1057   
                 (0.7698)        (0.8281)        (0.3584)        (0.5155)        (0.3942)        (0.2317)       (-0.4091)        (0.1061)       (-0.1454)       (-0.4386)   
NFIRMS            -0.1716         -0.0790          0.1095          0.0273          0.0924          0.1564          0.3901          0.2145          0.3206          0.4058   
                (-0.2827)       (-0.1616)        (0.2372)        (0.0546)        (0.1948)        (0.3406)        (1.1371)        (0.6342)        (0.8572)        (1.1148)   
FCFIRM             0.1643         -0.2306         -0.7050         -0.5302         -1.3960         -0.7499         -0.6088         -1.3333         -0.8095         -0.5513   
                 (0.0941)       (-0.1382)       (-0.5092)       (-0.3022)       (-1.0856)       (-0.7352)       (-0.7719)       (-1.0874)       (-0.9200)       (-0.6073)   
MARGIN             1.1374**        0.7720*         0.7420*         0.5409          0.3343          0.4295          0.2948         -0.3597          0.3036         -0.0030   
                 (2.3418)        (1.7993)        (1.9478)        (1.2911)        (0.6710)        (1.0841)        (0.5314)       (-0.3368)        (0.2356)       (-0.0033)   
LEVDISP           -0.0022          0.2363          0.0725          0.5919          0.2944          0.4385          0.2644          0.2651         -0.0433          0.0963   
                (-0.0011)        (0.1432)        (0.0417)        (0.3263)        (0.1779)        (0.2698)        (0.1413)        (0.1424)       (-0.0264)        (0.0619)   
SIZEDISP          -0.0387          0.0307          0.1642          0.1315          0.2040          0.2365          0.3054          0.1376          0.1875          0.2849   
                (-0.1369)        (0.1286)        (0.6774)        (0.5625)        (0.8189)        (1.0679)        (1.5141)        (0.5676)        (0.6690)        (1.0209)   
ENTRYR             0.0000         -0.0030          0.4019          0.0722         -0.2552          0.0391         -0.0099         -0.1736         -0.2510         -0.2626   
                      (.)       (-0.0054)        (0.7407)        (0.1290)       (-0.8574)        (0.0951)       (-0.0325)       (-0.2006)       (-0.7387)       (-0.9214)   
EXITR             -0.3475          0.1600          0.3100         -0.0141         -0.1314          0.2665          0.3176          0.1137         -0.0595         -0.1399   
                (-0.4376)        (0.2422)        (0.4429)       (-0.0211)       (-0.2864)        (0.4944)        (0.7820)        (0.2809)       (-0.0983)       (-0.2001)   
_cons             -2.7021         -5.7169**       -4.4212         -4.1241         -3.9158         -3.7323         -2.6553         -2.7141         -2.6220         -1.8506   
                (-0.9521)       (-2.2631)       (-1.6429)       (-1.4217)       (-1.4988)       (-1.4734)       (-0.9617)       (-1.0106)       (-0.7973)       (-0.6046)   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Industry              Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes             Yes   
N                    4576            4769            4813            4889            5168            5557            6418            6732            7387            8048   
r2_p               0.0907          0.0934          0.0894          0.0931          0.0878          0.0917          0.0951          0.0836          0.0767          0.0797   
----------------------------------------------------------------------------------------------------------------------------------------------------------------------------
t statistics in parentheses
* p<0.1, ** p<0.05, *** p<0.01
*/

**# 2.4 回归结果对比

use ybydata.dta, clear

*- 基准回归1（混合OLS）

qui: reg TFPQD_OP FB $xlist , cluster(city)
est store m1

*- 基准回归2（固定效应模型）

qui: reghdfe TFPQD_OP FB $xlist , $regopt
est store m2

*- PSM-DID1（使用权重不为空的样本）

qui: reghdfe TFPQD_OP FB $xlist if _weight != ., $regopt
est store m6

*- PSM-DID2（使用满足共同支撑假设的样本）

qui: reghdfe TFPQD_OP FB $xlist if _support == 1, $regopt
est store m7

*- PSM-DID3（使用频数加权回归）

gen     weight = _weight * 2
replace weight = 1 if treated == 1 & _weight != .
qui: reghdfe TFPQD_OP FB $xlist [fweight = weight], $regopt
est store m8

*- 回归结果输出

local mlist_2 "m1 m2 m6 m7 m8"
reg2docx `mlist_2' using 逐年匹配回归结果对比.docx, b(%6.4f) t(%6.4f)        ///
         scalars(N r2_a(%6.4f)) noconstant replace                           ///
         mtitles("OLS" "FE" "Weight!=." "On_Support" "Weight_Reg")           ///
         title("基准回归及逐年PSM-DID结果")

/*
local mlist_2 "m1 m2 m6 m7 m8"
esttab `mlist_2', mtitle("OLS" "FE" "Weight!=." "On_Support" "Weight_Reg")   ///
       b(%6.4f) t(%6.4f) s(N r2_a) nogap noconstant                          ///
       star(* 0.1 ** 0.05 *** 0.01)

--------------------------------------------------------------------------------------------
                      (1)             (2)             (3)             (4)             (5)   
                      OLS              FE       Weight!=.      On_Support      Weight_Reg   
--------------------------------------------------------------------------------------------
FB                -0.1243***      -0.0496***      -0.0493***      -0.0498***      -0.0466***
                (-5.2480)       (-3.6531)       (-3.5125)       (-3.6669)       (-3.1779)   
ADM                1.0682***       0.8719***       0.8917***       0.8712***       0.9117***
                (17.6388)       (18.0260)       (15.3250)       (17.9650)       (11.4538)   
PPE               -0.1183***      -0.0845***      -0.0899***      -0.0848***      -0.1136***
                (-4.3488)       (-5.4869)       (-4.8695)       (-5.5008)       (-4.9564)   
ADV                3.4239*         0.4029          0.3887          0.3767          4.4924   
                 (1.9284)        (0.2547)        (0.1959)        (0.2374)        (1.5339)   
RD                -1.1993         -3.5116***      -5.1446***      -3.5391***      -5.2116** 
                (-0.8120)       (-2.6572)       (-2.9252)       (-2.6649)       (-2.1192)   
HHI               -0.0284          0.1391***       0.1510***       0.1392***       0.0911*  
                (-0.5123)        (3.7371)        (3.6121)        (3.7313)        (1.7278)   
INDSIZE            0.1061***       0.0398***       0.0363***       0.0397***       0.0459***
                 (6.4798)        (5.1231)        (4.1622)        (5.1027)        (4.3791)   
NFIRMS            -0.2011***      -0.1012***      -0.0975***      -0.1011***      -0.1199***
                (-7.0272)       (-8.2637)       (-6.9857)       (-8.2429)       (-6.8619)   
FCFIRM             0.2561**       -0.0343         -0.1043         -0.0388          0.0600   
                 (2.5595)       (-0.5604)       (-1.3284)       (-0.6256)        (0.6081)   
MARGIN             0.2333***       0.2377***       0.2238***       0.2368***       0.3077***
                 (6.6555)        (8.2641)        (6.8292)        (8.2343)        (7.1966)   
LEVDISP            1.8228***       1.1270***       1.1647***       1.1270***       1.1589***
                (15.3788)       (20.1912)       (18.2101)       (20.1705)       (14.0951)   
SIZEDISP           0.1373***       0.0678***       0.0637***       0.0678***       0.0712***
                 (5.2810)        (4.5861)        (3.8471)        (4.5825)        (3.5551)   
ENTRYR             0.0735***       0.0732***       0.0635***       0.0743***       0.0563** 
                 (2.9277)        (3.2806)        (2.6220)        (3.3212)        (2.0777)   
EXITR              0.0560*         0.0491*         0.0468          0.0483*         0.0201   
                 (1.7687)        (1.7444)        (1.4509)        (1.7128)        (0.4843)   
--------------------------------------------------------------------------------------------
N                   81567           81567           58926           81507          116269   
r2_a               0.0646          0.1613          0.1548          0.1612          0.1590   
--------------------------------------------------------------------------------------------
t statistics in parentheses
* p<0.1, ** p<0.05, *** p<0.01
*/

更多资料，请关注微信公众号【草莓科研服务网】